import { useState, useEffect } from "react";
import { useMutation } from "@tanstack/react-query";
import { useAuth } from "@/hooks/use-auth";
import { useCurrency } from "@/providers/CurrencyProvider";
import { apiRequest, queryClient } from "@/lib/queryClient";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { formatCurrency } from "@/lib/utils";
import { Loader2 } from "lucide-react";
import { motion } from "framer-motion";
import { useToast } from "@/hooks/use-toast";
import { GameType } from "@shared/schema";

interface GameResult {
  isWin: boolean;
  winAmount: number;
  multiplier: number;
  gameData: {
    roll: number;
    chosenNumber: number;
  };
}

export function DiceGame() {
  const { user } = useAuth();
  const { currency: currentCurrency, getCurrencySymbol, formatAmount } = useCurrency();
  const currencySymbol = getCurrencySymbol(currentCurrency);
  const { toast } = useToast();
  
  const [betAmount, setBetAmount] = useState("0.001");
  const [chosenNumber, setChosenNumber] = useState(1);
  const [isRolling, setIsRolling] = useState(false);
  const [diceValue, setDiceValue] = useState(1);
  const [history, setHistory] = useState<{ isWin: boolean; amount: string; roll: number; chosen: number }[]>([]);
  
  // Update bet amount when currency changes
  useEffect(() => {
    setBetAmount("0.001");
  }, [currentCurrency]);

  const rollMutation = useMutation({
    mutationFn: async () => {
      const res = await apiRequest("POST", "/api/games/play", {
        gameType: "DICE" as GameType,
        betAmount: parseFloat(betAmount),
        currency: currentCurrency,
        chosenNumber: chosenNumber
      });
      return res.json() as Promise<GameResult>;
    },
    onSuccess: (data) => {
      setDiceValue(data.gameData.roll);
      setHistory(prev => [
        { 
          isWin: data.isWin, 
          amount: data.isWin ? data.winAmount.toString() : betAmount,
          roll: data.gameData.roll,
          chosen: data.gameData.chosenNumber
        },
        ...prev.slice(0, 9)
      ]);
      
      toast({
        title: data.isWin ? "You won!" : "You lost",
        description: `You rolled ${data.gameData.roll} ${data.isWin ? 'and chose' : 'but chose'} ${data.gameData.chosenNumber}${data.isWin ? '! Perfect match!' : ''}`,
        variant: data.isWin ? "default" : "destructive",
      });
      
      queryClient.invalidateQueries({ queryKey: ["/api/wallet/balance"] });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
    onSettled: () => {
      setTimeout(() => {
        setIsRolling(false);
      }, 1000);
    }
  });
  
  const handleRoll = () => {
    if (!user) return;
    
    const betValue = parseFloat(betAmount);
    if (isNaN(betValue) || betValue <= 0) {
      toast({
        title: "Invalid bet",
        description: "Please enter a valid bet amount",
        variant: "destructive",
      });
      return;
    }
    
    setIsRolling(true);
    rollMutation.mutate();
  };
  
  const handleHalfBet = () => {
    const currentBet = parseFloat(betAmount);
    if (!isNaN(currentBet)) {
      setBetAmount((currentBet / 2).toFixed(3));
    }
  };
  
  const handleDoubleBet = () => {
    const currentBet = parseFloat(betAmount);
    if (!isNaN(currentBet)) {
      setBetAmount((currentBet * 2).toFixed(3));
    }
  };
  
  const possibleWin = parseFloat(betAmount) * 5;

  // Render dots on dice face with Stake.com-inspired styling
  const renderDiceFace = (value: number) => {
    const dot = "bg-white rounded-full w-5 h-5 shadow-md";
    switch (value) {
      case 1:
        return (
          <div className="grid place-items-center h-full w-full">
            <div className={dot}></div>
          </div>
        );
      case 2:
        return (
          <div className="grid grid-cols-2 gap-6 p-4 h-full w-full">
            <div className={dot}></div>
            <div className={dot + " justify-self-end self-end"}></div>
          </div>
        );
      case 3:
        return (
          <div className="grid grid-cols-3 grid-rows-3 gap-3 p-3 h-full w-full">
            <div className={dot}></div>
            <div></div>
            <div className={dot + " justify-self-end"}></div>
            <div></div>
            <div className={dot + " place-self-center"}></div>
            <div></div>
            <div className={dot + " self-end"}></div>
            <div></div>
            <div className={dot + " justify-self-end self-end"}></div>
          </div>
        );
      case 4:
        return (
          <div className="grid grid-cols-2 gap-6 p-4 h-full w-full">
            <div className={dot}></div>
            <div className={dot + " justify-self-end"}></div>
            <div className={dot + " self-end"}></div>
            <div className={dot + " justify-self-end self-end"}></div>
          </div>
        );
      case 5:
        return (
          <div className="grid grid-cols-3 grid-rows-3 gap-3 p-3 h-full w-full">
            <div className={dot}></div>
            <div></div>
            <div className={dot + " justify-self-end"}></div>
            <div></div>
            <div className={dot + " place-self-center"}></div>
            <div></div>
            <div className={dot + " self-end"}></div>
            <div></div>
            <div className={dot + " justify-self-end self-end"}></div>
          </div>
        );
      case 6:
        return (
          <div className="grid grid-cols-2 gap-4 p-4 h-full w-full">
            <div className={dot}></div>
            <div className={dot + " justify-self-end"}></div>
            <div className={dot}></div>
            <div className={dot + " justify-self-end"}></div>
            <div className={dot + " self-end"}></div>
            <div className={dot + " justify-self-end self-end"}></div>
          </div>
        );
      default:
        return null;
    }
  };
  
  return (
    <div className="bg-[#1a1a1a] rounded-2xl p-6 max-w-2xl mx-auto border border-[#2a2a2a] shadow-lg">
      <div className="flex flex-col items-center mb-6">
        <h2 className="text-2xl font-bold text-white mb-2 font-sans">Dice Game</h2>
        <p className="text-sm text-[#7a7a7a] font-sans">Pick a number 1-6 and roll the dice to win 5x your bet!</p>
      </div>

      {/* Dice Display */}
      <div className="flex justify-center items-center gap-8 mb-8">
        <div className="text-center">
          <p className="text-sm text-[#7a7a7a] mb-2 font-sans">Dice Roll</p>
          <motion.div 
            className="w-32 h-32 bg-[#2a2a2a] rounded-lg flex items-center justify-center border-2 border-[#3a3a3a] shadow-xl"
            animate={isRolling ? { 
              rotateX: [0, 360, 0], 
              rotateY: [0, 360, 0],
              scale: [1, 1.2, 1]
            } : {}}
            transition={{ duration: 1.2, ease: "easeInOut", times: [0, 0.5, 1] }}
          >
            {renderDiceFace(diceValue)}
          </motion.div>
          <p className="mt-2 text-xl font-bold text-white font-sans">{diceValue}</p>
        </div>
        
        <div className="text-2xl font-bold text-[#7a7a7a] font-sans">VS</div>
        
        <div className="text-center">
          <p className="text-sm text-[#7a7a7a] mb-2 font-sans">Your Pick</p>
          <div className="w-32 h-32 bg-[#2ecc71] rounded-lg flex items-center justify-center border-2 border-[#27ae60] shadow-xl">
            {renderDiceFace(chosenNumber)}
          </div>
          <p className="mt-2 text-xl font-bold text-white font-sans">{chosenNumber}</p>
        </div>
      </div>

      {/* Number Selection */}
      <div className="mb-6">
        <p className="text-sm text-[#7a7a7a] mb-3 text-center font-sans">Select Number (1-6)</p>
        <div className="grid grid-cols-6 gap-2 max-w-md mx-auto">
          {[1, 2, 3, 4, 5, 6].map((number) => (
            <Button
              key={number}
              onClick={() => setChosenNumber(number)}
              disabled={isRolling}
              className={`w-12 h-12 rounded-lg font-bold text-lg font-sans transition-all duration-200 ${
                chosenNumber === number
                  ? 'bg-[#2ecc71] text-black border-2 border-[#27ae60] shadow-md'
                  : 'bg-[#2a2a2a] text-white border border-[#3a3a3a] hover:bg-[#2ecc71] hover:text-black'
              }`}
            >
              {number}
            </Button>
          ))}
        </div>
      </div>

      {/* Bet Controls */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        <div className="bg-[#2a2a2a] border border-[#3a3a3a] rounded-lg p-4">
          <p className="text-sm text-[#7a7a7a] mb-1 font-sans">Bet Amount</p>
          <div className="flex items-center gap-2">
            <Input
              type="number"
              value={betAmount}
              onChange={(e) => setBetAmount(e.target.value)}
              className="bg-transparent border-none text-white text-lg focus:ring-0 font-sans"
              disabled={isRolling}
              step="0.001"
              min="0.001"
            />
            <span className="text-white font-medium font-sans">{currencySymbol}</span>
          </div>
          <div className="flex gap-2 mt-2">
            <Button
              onClick={handleHalfBet}
              disabled={isRolling}
              className="bg-[#3a3a3a] text-white hover:bg-[#4a4a4a] text-sm font-sans"
            >
              1/2
            </Button>
            <Button
              onClick={handleDoubleBet}
              disabled={isRolling}
              className="bg-[#3a3a3a] text-white hover:bg-[#4a4a4a] text-sm font-sans"
            >
              2x
            </Button>
          </div>
        </div>
        
        <div className="bg-[#2a2a2a] border border-[#3a3a3a] rounded-lg p-4 flex flex-col justify-between">
          <div className="flex justify-between text-white font-semibold text-sm font-sans">
            <span>Multiplier</span>
            <span>5.00x</span>
          </div>
          <div className="flex justify-between text-white font-semibold text-sm font-sans">
            <span>Possible Win</span>
            <span>{formatCurrency(possibleWin, currentCurrency)}</span>
          </div>
        </div>
      </div>

      {/* Roll Button */}
      <Button 
        className="w-full py-3 rounded-lg bg-[#2ecc71] text-black font-bold text-lg hover:bg-[#27ae60] transition duration-200 shadow-md font-sans"
        onClick={handleRoll}
        disabled={isRolling || rollMutation.isPending}
      >
        {isRolling || rollMutation.isPending ? (
          <span className="flex items-center justify-center">
            <Loader2 className="mr-2 h-6 w-6 animate-spin" />
            Rolling...
          </span>
        ) : (
          "ðŸŽ² Roll Dice"
        )}
      </Button>

      {/* History */}
      <div className="mt-6 bg-[#2a2a2a] p-4 rounded-lg border border-[#3a3a3a]">
        <h3 className="font-medium text-white mb-2 font-sans">Recent Rolls</h3>
        {history.length === 0 ? (
          <p className="text-[#7a7a7a] text-sm font-sans">No recent rolls</p>
        ) : (
          <div className="flex gap-2 overflow-x-auto pb-2">
            {history.map((item, index) => (
              <div 
                key={index} 
                className={`w-10 h-10 flex items-center justify-center rounded-lg font-bold text-sm font-sans ${
                  item.isWin ? 'bg-[#2ecc71] text-black' : 'bg-[#e74c3c] text-white'
                }`}
                title={`Rolled: ${item.roll}, Chose: ${item.chosen} - ${item.isWin ? 'WIN' : 'LOSS'}: ${formatCurrency(item.amount, currentCurrency)}`}
              >
                {item.roll}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}