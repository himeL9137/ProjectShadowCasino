Please fix the balance update system for Project Shadow Casino, an online casino app built with React, TypeScript, Node.js, SQLite, Redux, Tailwind CSS, and WebSocket on Replit. The app supports Slots, Dice, and Plinko games with multiple currencies (BDT, USD, INR, BTC, JPY). Currently, there are two issues: (1) when a player loses a bet, the balance deduction is very slow, causing delays in UI updates, and (2) when a player wins, the winnings are not added to the wallet or reflected globally across the app. The goal is to ensure instant balance updates (deductions and additions) in real-time, reflected globally across all games and UI components, without requiring a page refresh.

Tech Stack and File Structure:
Frontend: React, TypeScript, Redux (client/src/store/ for state management), Tailwind CSS.
Backend: Node.js, SQLite (server/database/) for user data and balances, WebSocket for real-time updates.
Games: Located in client/src/components/games/ (Slots.tsx, DiceGAN.tsx, Plinko.tsx).
Admin panel: Allows superusers ("shadowHimel", "Albab AJ") to manage balances, located in client/src/components/admin/.
WebSocket: Used for real-time communication, implemented in server/websocket.ts.
Current Issues:
Slow balance deduction: When a player loses a bet, the balance update is delayed, taking several seconds to reflect in the UI.
Winnings not added: When a player wins, the winnings (1.1x payout for wins, capped at 150 BDT or equivalent) are not added to the wallet or reflected globally.
Currency consistency: Ensure updates work across all supported currencies (BDT, USD, INR, BTC, JPY) with conversions (e.g., 1 USD = 145 JPY, 1 USD = 122.73 BDT).
Requirements:
Implement instant balance updates using WebSocket for both deductions (losses) and additions (wins), ensuring the UI reflects changes immediately.
Use Redux to manage global state, ensuring the balance is consistent across all games and UI components.
Update the SQLite database (users table) to persist balance changes immediately after each game action.
Validate all balance updates on the backend to prevent mismatches or errors (e.g., negative balances or incorrect additions).
Ensure currency conversions are applied correctly during updates, using fixed rates (e.g., 1 USD = 145 JPY) stored in server/config/currency.ts.
Handle errors gracefully, logging issues to server/logs/ and displaying user-friendly messages in the UI.
Maintain compatibility with the existing Adsterra ad system (pop-ups every 5 minutes) and admin panel features.
Implementation Steps:
WebSocket Optimization: In server/websocket.ts, optimize the WebSocket connection to broadcast balance updates to all connected clients instantly after a game action. Ensure low latency by minimizing payload size and handling reconnection logic.
Redux State Management: In client/src/store/balanceSlice.ts, create actions and reducers to update the balance globally. Dispatch balance updates after receiving WebSocket messages.
Backend Validation: In server/routes/game.ts, add endpoints to handle game results (win/loss). Validate bets and winnings, update the users table in SQLite, and emit a WebSocket event with the new balance.
Game Components: Update Slots.tsx, DiceGAN.tsx, and Plinko.tsx to dispatch Redux actions and listen for WebSocket updates. Ensure each game sends bet/win data to the backend and reflects the updated balance instantly.
Currency Handling: In server/services/currency.ts, ensure balance updates account for the user’s selected currency, applying conversions before updating the database and UI.
Error Handling: Add try-catch blocks in backend routes and frontend components. Log errors to server/logs/error.log and show toast notifications (using Tailwind CSS) for issues like failed updates.
Testing: Test balance updates for all games in all currencies, ensuring deductions and additions are instant (within 100ms) and consistent across the app. Verify admin panel updates reflect instantly.
Example Code Snippets:
WebSocket (server/websocket.ts):
typescript

Copy
import { WebSocketServer } from 'ws';
const wss = new WebSocketServer({ port: 8080 });
wss.on('connection', (ws) => {
  ws.on('message', async (data) => {
    const { userId, game, amount, result, currency } = JSON.parse(data);
    const newBalance = await updateBalance(userId, game, amount, result, currency);
    wss.clients.forEach((client) => client.send(JSON.stringify({ userId, balance: newBalance, currency })));
  });
});
Redux Slice (client/src/store/balanceSlice.ts):
typescript

Copy
import { createSlice } from '@reduxjs/toolkit';
const balanceSlice = createSlice({
  name: 'balance',
  initialState: { value: 0, currency: 'BDT' },
  reducers: {
    updateBalance: (state, action) => {
      state.value = action.payload.balance;
      state.currency = action.payload.currency;
    },
  },
});
export const { updateBalance } = balanceSlice.actions;
export default balanceSlice.reducer;
Game Component Update (client/src/components/games/Slots.tsx):
typescript

Copy
import { useDispatch, useSelector } from 'react-redux';
import { updateBalance } from '../../store/balanceSlice';
import { useEffect } from 'react';
const Slots = () => {
  const dispatch = useDispatch();
  const ws = new WebSocket('ws://localhost:8080');
  useEffect(() => {
    ws.onmessage = (event) => {
      const { balance, currency } = JSON.parse(event.data);
      dispatch(updateBalance({ balance, currency }));
    };
  }, []);
  const play = async (bet: number) => {
    const response = await fetch('/api/game/slots', {
      method: 'POST',
      body: JSON.stringify({ userId, bet, currency: selectedCurrency }),
    });
    const result = await response.json();
    ws.send(JSON.stringify({ userId, game: 'slots', amount: result.amount, result: result.outcome, currency: selectedCurrency }));
  };
  return <button onClick={() => play(10)}>Spin</button>;
};
Constraints:
Do not modify the existing Tailwind CSS themes or Adsterra ad system logic.
Ensure the solution works within Replit’s environment, avoiding external dependencies unless already used.
Maintain the win cap (150 BDT or equivalent) and payout structure (1.1x for wins, full loss otherwise).
Keep the database schema unchanged unless necessary, and document any changes in server/database/schema.sql.
Deliverables:
Updated server/websocket.ts, server/routes/game.ts, server/services/currency.ts, and client/src/store/balanceSlice.ts.
Modified game files (Slots.tsx, DiceGAN.tsx, Plinko.tsx) to handle real-time updates.
Error handling and logging system in server/logs/.
Test cases to verify instant updates for all games and currencies.